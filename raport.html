<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–†–∞–ø–æ—Ä—Ç</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
    --primary-color: #4caf50;
    --bg-dark: #1a1a1a;
    --bg-medium: #2b2b2b;
    --text-light: #ffffff;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    padding: 0;
    background: var(--bg-dark);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    color: var(--text-light);
    user-select: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
}

.controls {
    background: var(--bg-medium);
    border-left: 5px solid var(--primary-color);
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 80px;
}

.controls b {
    display: block;
    margin: 12px 0 6px;
    font-size: 16px;
    color: #e0e0e0;
}

.report-type {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.report-type label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
    transition: all 0.2s;
}

.report-type input[type="radio"] {
    margin: 0;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color);
}

textarea {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    font-family: Arial, sans-serif;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    background: #1e1e1e;
    color: var(--text-light);
    resize: vertical;
    -webkit-appearance: none;
    appearance: none;
    touch-action: manipulation;
    margin-bottom: 15px;
}

#text1 {
    height: 400px;
    min-height: 300px;
    max-height: 600px;
}

textarea:focus {
    outline: none;
    border-color: #66bb6a;
}

#signature-pad {
    width: 100%;
    height: 180px;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    background: #f0f0f0;
    margin-bottom: 15px;
    touch-action: none;
    display: block;
}

.fixed-buttons {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-medium);
    padding: 12px;
    display: flex;
    gap: 10px;
    z-index: 1500;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
}

button {
    flex: 1;
    min-width: 120px;
    padding: 14px 10px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-light);
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    touch-action: manipulation;
    -webkit-touch-callout: none;
}

button:active {
    transform: scale(0.98);
    background: #388e3c;
}

button.secondary {
    background: #2196f3;
}

button.secondary:active {
    background: #1976d2;
}

button.share-btn {
    background: #00acc1;
}

button.share-btn:active {
    background: #00838f;
}

.settings-btn {
    width: 100%;
    margin: 5px 0 15px;
    background: #ff9800;
}

.settings-btn:active {
    background: #f57c00;
}

/* –°—Ç–∏–ª—ñ –ê4 –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
#raportPage {
    width: 794px;
    background: white;
    color: #000000;
    font-family: 'Times New Roman', Times, serif;
    font-size: 12pt;
    line-height: 1.5;
    position: absolute;
    left: -9999px;
    top: -9999px;
    z-index: 10000;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–º—ñ—Å—Ç—É –ê4 */
.raport-content {
    width: 100%;
    padding: 57px 28px 57px 85px; /* –≤–µ—Ä—Ö/–Ω–∏–∑ 20–º–º = 57px, –ª—ñ–≤–æ 30–º–º = 85px, –ø—Ä–∞–≤–æ 10–º–º = 28px */
    box-sizing: border-box;
    background: white;
}

/* –û–∫—Ä–µ–º–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ */
.page {
    width: 794px;
    min-height: 1123px;
    background: white;
    position: relative;
    page-break-after: always;
    break-after: page;
}

.page:last-child {
    page-break-after: auto;
    break-after: auto;
}

/* –ê–¥—Ä–µ—Å–∞—Ç–∞ –ø—Ä–∞–≤–æ—Ä—É—á */
.recipient {
    text-align: right;
    margin-bottom: 48px;
    white-space: pre-line;
    line-height: 1.5;
    font-size: 12pt;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–†–∞–ø–æ—Ä—Ç" */
.report-title {
    text-align: center;
    margin-bottom: 36px;
    font-size: 14pt;
    font-weight: bold;
    text-transform: uppercase;
}

/* –ü–æ—á–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç—É */
.report-text-start {
    margin-bottom: 13.5px; /* –ü–æ–ª–æ–≤–∏–Ω–∞ line-height (27px/2) - —Ç–∞–∫–∞ –∂ —è–∫ –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏ */
    font-size: 12pt;
    font-weight: normal;
    text-align: left;
}

/* –ë–ª–æ–∫ –∑ –æ—Å–Ω–æ–≤–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º - –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –ü–û –®–ò–†–ò–ù–Ü —è–∫ —É Word */
.text-block {
    white-space: normal;
    text-align: justify;
    text-justify: inter-word;
    line-height: 1.5;
    font-size: 12pt;
    margin: 0;
    padding: 0;
    width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    /* –í—ñ–¥—Å—Ç—É–ø –ø–µ—Ä—à–æ–≥–æ —Ä—è–¥–∫–∞ –¥–ª—è –ö–û–ñ–ù–û–ì–û –∞–±–∑–∞—Ü—É */
    text-indent: 36px;
}

/* –í—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏ */
.paragraph-spacer {
    height: 13.5px; /* –ü–æ–ª–æ–≤–∏–Ω–∞ line-height (27px/2) */
    width: 100%;
}

/* –¢—Ä–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ –ø–µ—Ä–µ–¥ –ø—ñ–¥–ø–∏—Å–æ–º */
.signature-space {
    height: 81px;
    width: 100%;
}

/* –ü—ñ–¥–ø–∏—Å */
.signature-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-top: 0;
}

.position-block {
    text-align: left;
    width: 200px;
    font-size: 12pt;
    white-space: pre-line;
}

.signature-image-block {
    text-align: center;
    width: 250px;
}

.signature-image-block img {
    height: 50px;
    max-width: 200px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
}

.name-block {
    text-align: right;
    width: 200px;
    font-size: 12pt;
    white-space: pre-line;
}

/* –î–∞—Ç–∞ */
.date-block {
    text-align: left;
    font-size: 12pt;
    margin-top: 12px;
}

/* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: var(--bg-medium);
    padding: 25px;
    width: 100%;
    max-width: 500px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content b {
    display: block;
    margin: 15px 0 8px;
    color: #e0e0e0;
}

.modal-content textarea {
    height: 70px;
}

.modal-content .button-row {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-content .button-row button {
    flex: 1;
}

/* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ */
.loading {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 20px 30px;
    border-radius: 10px;
    z-index: 3000;
    font-size: 18px;
}

.progress {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 3000;
    text-align: center;
}

.progress-bar {
    width: 300px;
    height: 20px;
    background: #333;
    border-radius: 10px;
    margin-top: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #4caf50;
    width: 0%;
    transition: width 0.3s;
}

/* –ü—ñ–¥–∫–∞–∑–∫–∞ */
.hint {
    font-size: 12px;
    color: #aaa;
    margin-top: -10px;
    margin-bottom: 15px;
    padding-left: 5px;
}
</style>
</head>

<body>

<div class="controls">
    <button class="settings-btn" onclick="openSettingsModal()">üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–∞–ø–æ—Ä—Ç—É</button>
    
    <b>üìÖ –î–∞—Ç–∞ —Ä–∞–ø–æ—Ä—Ç—É:</b>
    <input type="date" id="reportDate" style="width:100%;margin-bottom:15px;padding:10px;font-size:16px;border-radius:8px;border:2px solid var(--primary-color);background:#1e1e1e;color:#fff;">

    <div class="report-type">
        <label>
            <input type="radio" name="reportType" value="application" checked onchange="changeReportType()">
            üéØ –†–∞–ø–æ—Ä—Ç –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é
        </label>
        <label>
            <input type="radio" name="reportType" value="simple" onchange="changeReportType()">
            üè† –ü—Ä–æ—Å—Ç–∏–π —Ä–∞–ø–æ—Ä—Ç
        </label>
    </div>

    <b id="label1">üìÑ –í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞–ø–æ—Ä—Ç–∞:</b>
    <textarea id="text1" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞–ø–æ—Ä—Ç–∞..."></textarea>
    <div class="hint">üí° –í–∏ –º–æ–∂–µ—Ç–µ –≤–≤–æ–¥–∏—Ç–∏ –¥–æ–≤–≥–∏–π —Ç–µ–∫—Å—Ç - –≤—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—ñ–±'—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏</div>

    <b>üñäÔ∏è –ü—ñ–¥–ø–∏—Å –ø–∞–ª—å—Ü–µ–º –∞–±–æ —Å—Ç–∏–ª—É—Å–æ–º:</b>
    <canvas id="signature-pad"></canvas>
</div>

<div class="fixed-buttons">
    <button onclick="clearPad()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
    <button onclick="applySignature()">üìù –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
    <button onclick="saveAndShare()" class="share-btn">üì§ –ó–±–µ—Ä–µ–≥—Ç–∏ —ñ –ø–æ—à–∏—Ä–∏—Ç–∏</button>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±–∞–≥–∞—Ç–æ—Å—Ç–æ—Ä—ñ–Ω–∫–æ–≤–æ–≥–æ —Ä–∞–ø–æ—Ä—Ç—É -->
<div id="raportPage"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <b>–ö–æ–º–∞–Ω–¥–∏—Ä—É</b>
        <textarea id="cmdInput" placeholder="üìÑ –í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–æ–º–∞–Ω–¥–∏—Ä—É –≤/—á –ê7097 –∫–∞–ø—ñ—Ç–∞–Ω—É –ö–∞—Ä–º–∞–∑—å –û.–í.)"></textarea>
        
        <b>–ü–æ—Å–∞–¥–∞</b>
        <textarea id="posInput" placeholder="üìÑ –í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –ø–æ—Å–∞–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–æ–º–∞–Ω–¥–∏—Ä 6 –µ–∫–≤—ñ–¥ 5 –µ–∫–≤–∑ –ó –ó–ö–†)"></textarea>
        
        <b>–ü–Ü–ë</b>
        <textarea id="nameInput" placeholder="üìÑ –í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ü–Ü–ë (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –º–æ–ª–æ–¥—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç –†–æ–º–∞–Ω–µ–Ω–∫–æ –†.–ü)"></textarea>
        
        <div class="button-row">
            <button onclick="saveSettings()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="secondary" onclick="closeSettingsModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div class="loading" id="loading">–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è PDF...</div>

<div class="progress" id="progress">
    <div id="progressText">–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è PDF...</div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
</div>

<script>
// ==================== –ë–ê–ó–û–í–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ====================

// –í–∏–±—ñ—Ä –¥–∞—Ç–∏
const dateInput = document.getElementById('reportDate');

function setTodayDate() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${yyyy}-${mm}-${dd}`;
}

function formatDate(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}.${month}.${year} —Ä.`;
}

setTodayDate();

// –ú–æ–±—ñ–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
(function() {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
})();

// –¢–µ–∫—Å—Ç–æ–≤–∏–π –±–ª–æ–∫
const text1 = document.getElementById('text1');
const label1 = document.getElementById('label1');

// –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è —Ç–∏–ø—É —Ä–∞–ø–æ—Ä—Ç—É
let currentReportType = 'application';

// –§—É–Ω–∫—Ü—ñ—è –∑–º—ñ–Ω–∏ —Ç–∏–ø—É —Ä–∞–ø–æ—Ä—Ç—É
function changeReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    
    currentReportType = reportType;
    
    if (reportType === 'simple') {
        label1.innerText = 'üìÑ –í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞–ø–æ—Ä—Ç–∞:';
    } else {
        label1.innerText = 'üìÑ –í—Å—Ç–∞–≤—Ç–µ —Å–º—Å –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é:';
    }
}

// ==================== –ü–Ü–î–ü–ò–° ====================

const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let drawing = false;

// –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä canvas
function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#000000';
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
function startDrawing(e) {
    drawing = true;
    ctx.beginPath();
    draw(e);
}

function draw(e) {
    if (!drawing) return;
    
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    let x, y;
    
    if (e.type.includes('touch')) {
        const touch = e.touches[0] || e.changedTouches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
    } else {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function stopDrawing() {
    drawing = false;
    ctx.beginPath();
}

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startDrawing(e);
}, {passive: false});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    draw(e);
}, {passive: false});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    stopDrawing();
}, {passive: false});

function clearPad() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    resizeCanvas();
}

function applySignature() {
    localStorage.setItem('signature', canvas.toDataURL());
}

// ==================== –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ====================

// –í–∏—Ç—è–≥ –¥–∞—Ç–∏ —ñ —á–∞—Å—É –∑ —Ç–µ–∫—Å—Ç—É –¥–ª—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É
function extractDateTime(text) {
    const match = text.match(/(\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4}).*?(\d{1,2}:\d{2})/);
    if (match) {
        const parts = match[1].split(/[.\-/]/);
        let day = parts[0].padStart(2, '0');
        let month = parts[1].padStart(2, '0');
        let year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        const time = match[2].replace(':', '-');
        return `${day}-${month}-${year}_${time}`;
    }
    return null;
}

// –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
function updateProgress(percent, message) {
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progress.style.display = 'block';
    progressFill.style.width = percent + '%';
    progressText.textContent = message || '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è PDF...';
    
    if (percent >= 100) {
        setTimeout(() => {
            progress.style.display = 'none';
        }, 500);
    }
}

// ==================== –°–¢–í–û–†–ï–ù–ù–Ø –ë–ê–ì–ê–¢–û–°–¢–û–†–Ü–ù–ö–û–í–û–ì–û –î–û–ö–£–ú–ï–ù–¢–ê ====================

function createMultiPageDocument() {
    const container = document.getElementById('raportPage');
    container.innerHTML = '';
    
    const cmdText = localStorage.getItem('cmd') || "–ö–æ–º–∞–Ω–¥–∏—Ä—É –≤/—á –ê7097 –∫–∞–ø—ñ—Ç–∞–Ω—É –ö–∞—Ä–º–∞–∑—å –û.–í.";
    const posText = localStorage.getItem('pos') || "–ö–æ–º–∞–Ω–¥–∏—Ä 6 –µ–∫–≤—ñ–¥ 5 –µ–∫–≤–∑ –ó –ó–ö–†";
    const nameText = localStorage.getItem('name') || "–º–æ–ª–æ–¥—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç –†–æ–º–∞–Ω–µ–Ω–∫–æ –†.–ü";
    const signature = localStorage.getItem('signature') || '';
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    const pageHeight = 1123;
    const topMargin = 57;
    const bottomMargin = 57;
    const lineHeight = 27;
    const signatureSpace = 81;
    const signatureHeight = 150;
    const headerHeight = 120;
    
    const requiredForSignature = signatureSpace + signatureHeight;
    
    const paragraphs = text1.value.split('\n').filter(p => p.trim() !== '');
    
    if (paragraphs.length === 0) return 0;
    
    let pages = [];
    let currentPageParagraphs = [];
    let currentPageHeight = topMargin;
    let isFirstPage = true;
    
    if (isFirstPage) {
        currentPageHeight += headerHeight;
    }
    
    // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –≤—Å—ñ—Ö –∞–±–∑–∞—Ü–∞—Ö
    for (let pIndex = 0; pIndex < paragraphs.length; pIndex++) {
        const paragraph = paragraphs[pIndex];
        
        // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –ø—Ä–∏–±–ª–∏–∑–Ω—É –≤–∏—Å–æ—Ç—É –∞–±–∑–∞—Ü—É
        const wordsCount = paragraph.split(' ').length;
        const linesCount = Math.ceil(wordsCount / 12);
        const paragraphHeight = linesCount * lineHeight;
        
        const isLastParagraph = (pIndex === paragraphs.length - 1);
        
        // –î–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∞–±–∑–∞—Ü—É —Ä–µ–∑–µ—Ä–≤—É—î–º–æ –º—ñ—Å—Ü–µ –ø—ñ–¥ –ø—ñ–¥–ø–∏—Å
        const requiredSpace = isLastParagraph 
            ? paragraphHeight + requiredForSignature + 20
            : paragraphHeight + 20;
        
        // –Ø–∫—â–æ –Ω–µ –≤–º—ñ—â–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
        if (currentPageHeight + requiredSpace > pageHeight - bottomMargin) {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
            pages.push({
                paragraphs: [...currentPageParagraphs],
                isFirst: isFirstPage,
                hasSignature: false
            });
            
            // –ü–æ—á–∏–Ω–∞—î–º–æ –Ω–æ–≤—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
            currentPageParagraphs = [];
            currentPageHeight = topMargin;
            isFirstPage = false;
        }
        
        // –î–æ–¥–∞—î–º–æ –∞–±–∑–∞—Ü
        currentPageParagraphs.push({
            text: paragraph
        });
        
        currentPageHeight += paragraphHeight;
        
        // –î–æ–¥–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏ (–∫—Ä—ñ–º –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ)
        if (pIndex < paragraphs.length - 1) {
            if (currentPageHeight + lineHeight/2 > pageHeight - bottomMargin) {
                pages.push({
                    paragraphs: [...currentPageParagraphs.slice(0, -1)],
                    isFirst: isFirstPage,
                    hasSignature: false
                });
                
                currentPageParagraphs = [currentPageParagraphs[currentPageParagraphs.length - 1]];
                currentPageHeight = topMargin + paragraphHeight;
                isFirstPage = false;
            } else {
                currentPageHeight += lineHeight/2;
            }
        }
    }
    
    // –î–æ–¥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ –ø—ñ–¥–ø–∏—Å–æ–º
    if (currentPageParagraphs.length > 0) {
        pages.push({
            paragraphs: [...currentPageParagraphs],
            isFirst: isFirstPage,
            hasSignature: true
        });
    }
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ HTML –¥–ª—è –∫–æ–∂–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    pages.forEach((page, index) => {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        
        let content = '<div class="raport-content">';
        
        if (page.isFirst) {
            content += `
                <div class="recipient">${cmdText}</div>
                <div class="report-title">–†–ê–ü–û–†–¢</div>
            `;
            
            if (currentReportType === 'application') {
                content += '<div class="report-text-start">–î—ñ–π—Å–Ω–∏–º –¥–æ–ø–æ–≤—ñ–¥–∞—é, —â–æ:</div>';
                
                // –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –ø—ñ—Å–ª—è "–î—ñ–π—Å–Ω–∏–º –¥–æ–ø–æ–≤—ñ–¥–∞—é, —â–æ:" —Ç–∞–∫–∏–π —Å–∞–º–∏–π —è–∫ –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏
                if (page.paragraphs && page.paragraphs.length > 0) {
                    content += '<div class="paragraph-spacer"></div>';
                }
            }
        }
        
        if (page.paragraphs && page.paragraphs.length > 0) {
            page.paragraphs.forEach((p, pIndex) => {
                // –ö–æ–∂–µ–Ω –∞–±–∑–∞—Ü
                content += `<div class="text-block">${p.text}</div>`;
                
                // –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏ (–∫—Ä—ñ–º –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ)
                if (pIndex < page.paragraphs.length - 1) {
                    content += '<div class="paragraph-spacer"></div>';
                }
            });
        }
        
        if (page.hasSignature) {
            const date = formatDate(dateInput.value);
            
            let signatureHTML = '';
            if (signature) {
                signatureHTML = `<img src="${signature}" style="height: 50px; max-width: 200px; object-fit: contain;">`;
            }
            
            content += '<div class="signature-space"></div>';
            
            content += `
                <div class="signature-row">
                    <div class="position-block">${posText}</div>
                    <div class="signature-image-block">
                        ${signatureHTML}
                    </div>
                    <div class="name-block">${nameText}</div>
                </div>
                <div class="date-block">${date}</div>
            `;
        }
        
        content += '</div>';
        pageDiv.innerHTML = content;
        container.appendChild(pageDiv);
    });
    
    return pages.length;
}

// –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
function waitForImages() {
    const images = document.querySelectorAll('img');
    const promises = Array.from(images).map(img => {
        if (img.complete && img.naturalWidth !== 0) return Promise.resolve();
        return new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve;
        });
    });
    return Promise.all(promises);
}

// ==================== –û–°–ù–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø ====================

async function saveAndShare() {
    const loading = document.getElementById('loading');
    
    if (!text1.value.trim()) {
        alert('‚ùå –í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞–ø–æ—Ä—Ç—É');
        return;
    }
    
    try {
        loading.style.display = 'block';
        updateProgress(10, '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–æ–∫...');
        
        const numPages = createMultiPageDocument();
        
        updateProgress(30, `–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ ${numPages} —Å—Ç–æ—Ä—ñ–Ω–æ–∫...`);
        
        const raportPage = document.getElementById('raportPage');
        
        const originalPosition = raportPage.style.position;
        const originalLeft = raportPage.style.left;
        const originalTop = raportPage.style.top;
        
        raportPage.style.position = 'fixed';
        raportPage.style.left = '50%';
        raportPage.style.top = '50%';
        raportPage.style.transform = 'translate(-50%, -50%)';
        raportPage.style.zIndex = '9999';
        raportPage.style.display = 'block';
        
        await waitForImages();
        
        updateProgress(50, '–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å...');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: 'a4'
        });
        
        const pages = raportPage.children;
        
        for (let i = 0; i < pages.length; i++) {
            updateProgress(50 + (i * 40 / pages.length), `–û–±—Ä–æ–±–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ${i + 1} –∑ ${pages.length}...`);
            
            for (let j = 0; j < pages.length; j++) {
                pages[j].style.display = j === i ? 'block' : 'none';
            }
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const canvas = await html2canvas(raportPage, {
                scale: 3,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123,
                windowWidth: 794,
                windowHeight: 1123
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const imgWidth = pdf.internal.pageSize.getWidth();
            const imgHeight = pdf.internal.pageSize.getHeight();
            
            if (i > 0) {
                pdf.addPage();
            }
            
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
        }
        
        updateProgress(95, '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É...');
        
        raportPage.style.position = originalPosition;
        raportPage.style.left = originalLeft;
        raportPage.style.top = originalTop;
        raportPage.style.transform = '';
        raportPage.style.zIndex = '';
        
        for (let i = 0; i < pages.length; i++) {
            pages[i].style.display = 'block';
        }
        
        let nameFromText = extractDateTime(text1.value);
        let today = new Date();
        
        let fileName;
        if (nameFromText) {
            fileName = `–†–∞–ø–æ—Ä—Ç_${nameFromText}.pdf`;
        } else {
            fileName = `–†–∞–ø–æ—Ä—Ç_${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}.pdf`;
        }
        
        const pdfBlob = pdf.output('blob');
        
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        let shared = false;
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
        
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: '–†–∞–ø–æ—Ä—Ç',
                    text: ''
                });
                shared = true;
            } catch (e) {
                console.log('–ü–æ—à–∏—Ä–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ');
            }
        }
        
        updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
        loading.style.display = 'none';
        
        let message = `‚úÖ –†–∞–ø–æ—Ä—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!\n\nüìÅ –§–∞–π–ª: ${fileName}\nüìÑ –°—Ç–æ—Ä—ñ–Ω–æ–∫: ${pages.length}`;
        
        if (shared) {
            message += '\n\nüì§ –§–∞–π–ª –ø–æ—à–∏—Ä–µ–Ω–æ!';
        }
        
        setTimeout(() => {
            alert(message);
        }, 500);
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        loading.style.display = 'none';
        document.getElementById('progress').style.display = 'none';
        alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
}

// ==================== –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û ====================

const settingsModal = document.getElementById('settingsModal');
const cmdInput = document.getElementById('cmdInput');
const posInput = document.getElementById('posInput');
const nameInput = document.getElementById('nameInput');

function openSettingsModal() {
    settingsModal.style.display = 'flex';
    cmdInput.value = localStorage.getItem('cmd') || "";
    posInput.value = localStorage.getItem('pos') || "";
    nameInput.value = localStorage.getItem('name') || "";
    setTimeout(() => cmdInput.focus(), 100);
}

function closeSettingsModal() {
    settingsModal.style.display = 'none';
}

function saveSettings() {
    localStorage.setItem('cmd', cmdInput.value);
    localStorage.setItem('pos', posInput.value);
    localStorage.setItem('name', nameInput.value);
    closeSettingsModal();
    alert('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
}

settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) {
        closeSettingsModal();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (settingsModal.style.display === 'flex') closeSettingsModal();
    }
});

window.addEventListener('load', () => {
    changeReportType();
});
</script>

</body>
</html>