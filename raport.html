<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<title>Рапорт</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
body{
    margin:0;
    background:#1a1a1a;
    font-family:Arial, sans-serif;
    color:#fff;
    user-select:none;
}
.controls{
    background:#2b2b2b;
    border-left:5px solid #4caf50;
    padding:15px;
    position:sticky;
    top:0;
    z-index:1000;
}
textarea{
    width:100%;
    height:90px;
    margin-bottom:12px;
    padding:10px;
    font-size:16px;
    font-family:Arial, sans-serif;
    border:2px solid #4caf50;
    border-radius:6px;
    background:#1e1e1e;
    color:#fff;
    resize:none;
}
#signature-pad{
    width:100%;
    height:140px;
    border:2px solid #4caf50;
    border-radius:6px;
    background:#f0f0f0;
    margin-bottom:10px;
    touch-action:none;
}
button{
    width:32%;
    margin:5px 1%;
    padding:12px;
    font-size:16px;
    font-weight:bold;
    color:#fff;
    background:#4caf50;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

.paper{
    width:210mm;
    height:297mm;
    margin:20px auto;
    padding:25mm 20mm 20mm 30mm;
    background:white;
    color:#1a1a1a;
    font-family:Arial, sans-serif;
    font-size:26px;
    line-height:1.6;
}

.header-right{
    text-align:right;
    margin-bottom:40px;
    white-space:pre-line;
}

.title{
    text-align:center;
    margin-bottom:25px;
}

.block{
    margin-top:15px;
    white-space:pre-line;
}

#block1{
    text-align:justify; /* вирівнювання по ширині */
}

.spacer{
    height:120px;
}

/* --- Футер --- */
.pos-sign-name-row{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:20px;
}

.signature-inline img{
    height:80px;
}

#nameBlock{
    white-space:nowrap;
}

.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:2000;
}
.modal-content{
    background:#2b2b2b;
    padding:20px;
    width:90%;
    max-width:500px;
    border-radius:8px;
}
.settings-btn{
    width:100%;
    margin-bottom:12px;
    background:#ff9800;
}
</style>
</head>

<body>

<div class="controls">

<button class="settings-btn" onclick="openModal()">Налаштування рапорту</button>

<b>Вставте смс по застосуванню:</b>
<textarea id="text1"></textarea>

<b>Вставте смс хто на БЧ:</b>
<textarea id="text2"></textarea>

<b>Підпис пальцем або стилусом:</b>
<canvas id="signature-pad"></canvas>

<div style="display:flex;justify-content:space-between;">
<button onclick="clearPad()">Очистити підпис</button>
<button onclick="applySignature()">Застосувати підпис</button>
<button onclick="shareRaport()">Поширити</button>
</div>
</div>

<!-- Модальне вікно -->
<div class="modal" id="modal">
  <div class="modal-content">
    <b>Командиру</b>
    <textarea id="cmdInput"></textarea>

    <b>Посада</b>
    <textarea id="posInput"></textarea>

    <b>ПІБ</b>
    <textarea id="nameInput"></textarea>

    <div style="display:flex;justify-content:space-between;margin-top:10px;">
      <button onclick="saveSettings()">Зберегти</button>
      <button onclick="closeModal()">Закрити</button>
    </div>
  </div>
</div>

<div class="paper" id="raportPage">
  <div class="header-right" id="cmdBlock"></div>

  <div class="title">Рапорт</div>
  <div>Дійсним доповідаю, що:</div>

  <div class="block" id="block1"></div>
  <div class="block" id="block2"></div>

  <div class="spacer"></div>

  <!-- Футер -->
  <div class="pos-sign-name-row">
      <div id="posBlock"></div>

      <div class="signature-inline">
          <img id="signImg">
      </div>

      <div id="nameBlock"></div>
  </div>

  <div id="date" style="margin-top:10px;"></div>
</div>

<script>
// Текстові блоки
text1.oninput=()=>block1.innerText=text1.value;
text2.oninput=()=>block2.innerText=text2.value;

// Дата
date.innerText=new Date().toLocaleDateString('uk-UA');

// Підпис
const canvas=document.getElementById('signature-pad');
const ctx=canvas.getContext('2d');
canvas.width=canvas.offsetWidth;
canvas.height=canvas.offsetHeight;
let drawing=false;

canvas.onpointerdown=e=>{
    drawing=true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX,e.offsetY);
}
canvas.onpointermove=e=>{
    if(!drawing)return;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
}
canvas.onpointerup=()=>drawing=false;

function clearPad(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
}
function applySignature(){
    signImg.src=canvas.toDataURL();
}

// Витяг дати і часу з тексту
function extractDateTime(text){
    const match=text.match(/(\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4}).*?(\d{1,2}:\d{2})/);
    if(match){
        const parts=match[1].split(/[.\-/]/);
        let day=parts[0].padStart(2,'0');
        let month=parts[1].padStart(2,'0');
        let year=parts[2].length===2 ? '20'+parts[2] : parts[2];
        const time=match[2].replace(':','-');
        return `${day}-${month}-${year}_${time}`;
    }
    return null;
}

// Збереження в JPEG з потрібною назвою
async function shareRaport(){
    const c=await html2canvas(raportPage,{scale:2});
    const blob=await new Promise(res=>c.toBlob(res,"image/jpeg",0.95));

    let nameFromText=extractDateTime(text1.value);

    let today=new Date();
    let fileName=nameFromText ? nameFromText+".jpeg"
        : `${String(today.getDate()).padStart(2,'0')}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}.jpeg`;

    const file=new File([blob],fileName,{type:"image/jpeg"});

    if(navigator.share){
        try{
            await navigator.share({files:[file],title:"Рапорт"});
        }catch(e){}
    }

    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=fileName;
    a.click();
}

// Модалка + localStorage
function openModal(){
    modal.style.display="flex";
    cmdInput.value=localStorage.getItem('cmd')||"";
    posInput.value=localStorage.getItem('pos')||"";
    nameInput.value=localStorage.getItem('name')||"";
}
function closeModal(){
    modal.style.display="none";
}
function saveSettings(){
    localStorage.setItem('cmd',cmdInput.value);
    localStorage.setItem('pos',posInput.value);
    localStorage.setItem('name',nameInput.value);
    applySettings();
    closeModal();
}
function applySettings(){
    cmdBlock.innerText=localStorage.getItem('cmd')||"Налаштуй рапорт";
    posBlock.innerText=localStorage.getItem('pos')||"Налаштуй рапорт";
    nameBlock.innerText=localStorage.getItem('name')||"Налаштуй рапорт";
}
applySettings();
</script>

</body>
</html>
