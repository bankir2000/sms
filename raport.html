<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–†–∞–ø–æ—Ä—Ç</title>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
:root {
    --primary-color: #4caf50;
    --bg-dark: #1a1a1a;
    --bg-medium: #2b2b2b;
    --text-light: #ffffff;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    padding: 0;
    background: var(--bg-dark);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    color: var(--text-light);
    user-select: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
}

.controls {
    background: var(--bg-medium);
    border-left: 5px solid var(--primary-color);
    padding: 20px;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 80px; /* –î–æ–¥–∞–Ω–æ –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ */
}

.controls b {
    display: block;
    margin: 12px 0 6px;
    font-size: 16px;
    color: #e0e0e0;
}

.report-type {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.report-type label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 6px;
    background: rgba(255,255,255,0.1);
    transition: all 0.2s;
}

.report-type input[type="radio"] {
    margin: 0;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color);
}

textarea {
    width: 100%;
    height: 90px;
    margin-bottom: 15px;
    padding: 12px;
    font-size: 16px;
    font-family: Arial, sans-serif;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    background: #1e1e1e;
    color: var(--text-light);
    resize: none;
    -webkit-appearance: none;
    appearance: none;
    touch-action: manipulation;
}

textarea:focus {
    outline: none;
    border-color: #66bb6a;
}

#signature-pad {
    width: 100%;
    height: 180px;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    background: #f0f0f0;
    margin-bottom: 15px;
    touch-action: none;
    display: block;
}

.fixed-buttons {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-medium);
    padding: 12px;
    display: flex;
    gap: 10px;
    z-index: 1500;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
}

button {
    flex: 1;
    min-width: 120px;
    padding: 14px 10px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-light);
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    touch-action: manipulation;
    -webkit-touch-callout: none;
}

button:active {
    transform: scale(0.98);
    background: #388e3c;
}

button.secondary {
    background: #2196f3;
}

button.secondary:active {
    background: #1976d2;
}

.settings-btn {
    width: 100%;
    margin: 5px 0 15px;
    background: #ff9800;
}

.settings-btn:active {
    background: #f57c00;
}

/* –°—Ç–∏–ª—ñ –ê4 –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
#raportPage {
    width: 794px; /* 210mm –ø—Ä–∏ 96 DPI */
    height: 1123px; /* 297mm –ø—Ä–∏ 96 DPI */
    background: white;
    color: #000000;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14pt;
    line-height: 1.5;
    position: absolute;
    left: -9999px;
    top: -9999px;
    z-index: 10000;
    overflow: hidden;
    page-break-inside: avoid;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–º—ñ—Å—Ç—É –ê4 */
.raport-content {
    width: 100%;
    height: 100%;
    padding: 100px 113px 80px 113px; /* 25mm 30mm 20mm 30mm –ø—Ä–∏ 96 DPI */
    box-sizing: border-box;
}

/* –ê–¥—Ä–µ—Å–∞—Ç–∞ –ø—Ä–∞–≤–æ—Ä—É—á */
.recipient {
    text-align: right;
    margin-bottom: 60px; /* 15mm */
    white-space: pre-line;
    line-height: 1.5;
    font-size: 14pt;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–†–∞–ø–æ—Ä—Ç" */
.report-title {
    text-align: center;
    margin-bottom: 45px; /* 11mm */
    font-size: 16pt;
    font-weight: bold;
    text-transform: uppercase;
}

/* –ü–æ—á–∞—Ç–æ–∫ —Ç–µ–∫—Å—Ç—É */
.report-text-start {
    margin-bottom: 20px;
    font-size: 14pt;
}

/* –ë–ª–æ–∫ –∑ –æ—Å–Ω–æ–≤–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º */
.text-block {
    white-space: pre-line;
    text-align: justify;
    line-height: 1.5;
    font-size: 14pt;
    margin-bottom: 10px;
}

#block1 {
    text-indent: 35px;
    margin-bottom: 30px;
}

/* –ë–ª–æ–∫ "–ù–∞ –ë–ß" */
#block2 {
    text-align: left;
    white-space: pre-line;
    line-height: 1.5;
    margin-bottom: 150px; /* –ü—Ä–æ—Å—Ç—ñ—Ä –¥–ª—è –ø—ñ–¥–ø–∏—Å—É */
}

/* –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –ø—ñ–¥–ø–∏—Å—É, –ø–æ—Å–∞–¥–∏ —Ç–∞ –ü–Ü–ë */
.signature-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    position: absolute;
    bottom: 150px;
    left: 113px;
    right: 113px;
}

.position-block {
    text-align: left;
    width: 200px;
    font-size: 12pt;
    white-space: pre-line;
}

.signature-image-block {
    text-align: center;
    width: 250px;
}

.signature-image-block img {
    height: 60px;
    max-width: 200px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
}

.name-block {
    text-align: right;
    width: 200px;
    font-size: 12pt;
    white-space: pre-line;
}

/* –î–∞—Ç–∞ - –ü–ï–†–ï–ù–ï–°–ï–ù–ê –ù–ê –õ–ò–í–ò–ô –ë–Ü–ö */
.date-block {
    position: absolute;
    bottom: 100px;
    left: 113px; /* –ó–º—ñ–Ω–µ–Ω–æ –∑ right –Ω–∞ left */
    font-size: 11pt;
}

/* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: var(--bg-medium);
    padding: 25px;
    width: 100%;
    max-width: 500px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content b {
    display: block;
    margin: 15px 0 8px;
    color: #e0e0e0;
}

.modal-content textarea {
    height: 70px;
}

.modal-content .button-row {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-content .button-row button {
    flex: 1;
}

/* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
.loading {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 20px 30px;
    border-radius: 10px;
    z-index: 3000;
    font-size: 18px;
}
</style>
</head>

<body>

<div class="controls">
    <button class="settings-btn" onclick="openSettingsModal()">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–∞–ø–æ—Ä—Ç—É</button>
    <b>üìÖ –î–∞—Ç–∞ —Ä–∞–ø–æ—Ä—Ç—É:</b>
    <input type="date" id="reportDate" style="width:100%;margin-bottom:15px;padding:10px;font-size:16px;border-radius:8px;border:2px solid var(--primary-color);background:#1e1e1e;color:#fff;">

    <div class="report-type">
        <label>
            <input type="radio" name="reportType" value="application" checked onchange="changeReportType()">
            üéØ –†–∞–ø–æ—Ä—Ç –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é
        </label>
        <label>
            <input type="radio" name="reportType" value="simple" onchange="changeReportType()">
            üè† –ü—Ä–æ—Å—Ç–∏–π —Ä–∞–ø–æ—Ä—Ç
        </label>
    </div>

    <b id="label1">–í—Å—Ç–∞–≤—Ç–µ —Å–º—Å –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é:</b>
    <textarea id="text1" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç..."></textarea>

    <b id="label2">–í—Å—Ç–∞–≤—Ç–µ —Å–º—Å —Ö—Ç–æ –Ω–∞ –ë–ß:</b>
    <textarea id="text2" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç..."></textarea>

    <b>üñäÔ∏è –ü—ñ–¥–ø–∏—Å –ø–∞–ª—å—Ü–µ–º –∞–±–æ —Å—Ç–∏–ª—É—Å–æ–º:</b>
    <canvas id="signature-pad"></canvas>
</div>

<div class="fixed-buttons">
    <button onclick="clearPad()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
    <button onclick="applySignature()">üìù –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
    <button onclick="shareRaport()">üì§ –ü–æ—à–∏—Ä–∏—Ç–∏</button>
</div>

<!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–∞–ø–æ—Ä—Ç—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è -->
<div id="raportPage">
    <div class="raport-content">
        <div class="recipient" id="cmdBlock"></div>
        
        <div class="report-title">–†–∞–ø–æ—Ä—Ç</div>
        <div class="report-text-start">–î—ñ–π—Å–Ω–∏–º –¥–æ–ø–æ–≤—ñ–¥–∞—é, —â–æ:</div>
        
        <div class="text-block" id="block1"></div>
        <div class="text-block" id="block2"></div>
        
        <div class="signature-row">
            <div class="position-block" id="posBlock"></div>
            <div class="signature-image-block">
                <img id="signImg">
            </div>
            <div class="name-block" id="nameBlock"></div>
        </div>
        
        <div class="date-block" id="date"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <b>–ö–æ–º–∞–Ω–¥–∏—Ä—É</b>
        <textarea id="cmdInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏—Ä–∞"></textarea>
        
        <b>–ü–æ—Å–∞–¥–∞</b>
        <textarea id="posInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –ø–æ—Å–∞–¥—É"></textarea>
        
        <b>–ü–Ü–ë</b>
        <textarea id="nameInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ü–Ü–ë"></textarea>
        
        <div class="button-row">
            <button onclick="saveSettings()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="secondary" onclick="closeSettingsModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div class="loading" id="loading">–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —Ä–∞–ø–æ—Ä—Ç –ê4...</div>

<script>
// –í–∏–±—ñ—Ä –¥–∞—Ç–∏
const dateInput = document.getElementById('reportDate');
const dateElement = document.getElementById('date');

function setTodayDate() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${yyyy}-${mm}-${dd}`;
    updateDateFromInput();
}

function updateDateFromInput() {
    const [year, month, day] = dateInput.value.split('-');
    dateElement.innerText = `${day}.${month}.${year} —Ä.`;
}

dateInput.addEventListener('change', updateDateFromInput);
setTodayDate();

// –ú–æ–±—ñ–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
(function() {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
})();

// –¢–µ–∫—Å—Ç–æ–≤—ñ –±–ª–æ–∫–∏
const text1 = document.getElementById('text1');
const text2 = document.getElementById('text2');
const block1 = document.getElementById('block1');
const block2 = document.getElementById('block2');

// –î–û–î–ê–ù–û: –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –º—ñ—Ç–æ–∫
const label1 = document.getElementById('label1');
const label2 = document.getElementById('label2');

// –î–û–î–ê–ù–û: –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è —Ç–∏–ø—É —Ä–∞–ø–æ—Ä—Ç—É
let currentReportType = 'application';

text1.addEventListener('input', () => {
    block1.innerText = text1.value;
});

text2.addEventListener('input', () => {
    block2.innerText = text2.value;
});

// –î–û–î–ê–ù–û: –§—É–Ω–∫—Ü—ñ—è –∑–º—ñ–Ω–∏ —Ç–∏–ø—É —Ä–∞–ø–æ—Ä—Ç—É
function changeReportType() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const reportStartElement = document.querySelector('.report-text-start');
    
    currentReportType = reportType; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∏–ø
    
    if (reportType === 'simple') {
        // –ü—Ä–æ—Å—Ç–∏–π —Ä–∞–ø–æ—Ä—Ç
        label1.innerText = '–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ä–∞–ø–æ—Ä—Ç–∞:';
        label2.innerText = '–ù–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è:';
        if (reportStartElement) {
            reportStartElement.style.display = 'none';
        }
    } else {
        // –†–∞–ø–æ—Ä—Ç –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é
        label1.innerText = '–í—Å—Ç–∞–≤—Ç–µ —Å–º—Å –ø–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—é:';
        label2.innerText = '–í—Å—Ç–∞–≤—Ç–µ —Å–º—Å —Ö—Ç–æ –Ω–∞ –ë–ß:';
        if (reportStartElement) {
            reportStartElement.style.display = 'block';
        }
    }
}

// –ü—ñ–¥–ø–∏—Å
const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let drawing = false;

// –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä canvas
function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#000000';
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
function startDrawing(e) {
    drawing = true;
    ctx.beginPath();
    draw(e);
}

function draw(e) {
    if (!drawing) return;
    
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    let x, y;
    
    if (e.type.includes('touch')) {
        const touch = e.touches[0] || e.changedTouches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
    } else {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function stopDrawing() {
    drawing = false;
    ctx.beginPath();
}

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startDrawing(e);
}, {passive: false});

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    draw(e);
}, {passive: false});

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    stopDrawing();
}, {passive: false});

function clearPad() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    resizeCanvas();
}

function applySignature() {
    const signImg = document.getElementById('signImg');
    signImg.src = canvas.toDataURL();
    localStorage.setItem('signature', signImg.src);
}

// –í–∏—Ç—è–≥ –¥–∞—Ç–∏ —ñ —á–∞—Å—É –∑ —Ç–µ–∫—Å—Ç—É –¥–ª—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É
function extractDateTime(text) {
    const match = text.match(/(\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4}).*?(\d{1,2}:\d{2})/);
    if (match) {
        const parts = match[1].split(/[.\-/]/);
        let day = parts[0].padStart(2, '0');
        let month = parts[1].padStart(2, '0');
        let year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        const time = match[2].replace(':', '-');
        return `–†–∞–ø–æ—Ä—Ç_${day}-${month}-${year}_${time}`;
    }
    return null;
}

// –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ê4
async function shareRaport() {
    const loading = document.getElementById('loading');
    try {
        loading.style.display = 'block';
        
        const raportPage = document.getElementById('raportPage');
        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –µ–ª–µ–º–µ–Ω—Ç–∞ "–î—ñ–π—Å–Ω–∏–º –¥–æ–ø–æ–≤—ñ–¥–∞—é, —â–æ:" –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—î—é
        const reportStartElement = raportPage.querySelector('.report-text-start');
        if (reportStartElement) {
            if (currentReportType === 'simple') {
                reportStartElement.style.display = 'none';
            } else {
                reportStartElement.style.display = 'block';
            }
        }
            
        // –¢–∏–º—á–∞—Å–æ–≤–æ –ø–æ–∫–∞–∑—É—î–º–æ —Ä–∞–ø–æ—Ä—Ç
        const originalPosition = raportPage.style.position;
        const originalLeft = raportPage.style.left;
        const originalTop = raportPage.style.top;
        const originalZIndex = raportPage.style.zIndex;
        const originalDisplay = raportPage.style.display;
        
        raportPage.style.position = 'fixed';
        raportPage.style.left = '50%';
        raportPage.style.top = '50%';
        raportPage.style.transform = 'translate(-50%, -50%)';
        raportPage.style.zIndex = '9999';
        raportPage.style.display = 'block';
        
        // –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
        await waitForImages();
        
        const c = await html2canvas(raportPage, {
            scale: 3,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            width: 794,
            height: 1123,
            windowWidth: 794,
            windowHeight: 1123,
            onclone: function(clonedDoc) {
                const clonedPaper = clonedDoc.getElementById('raportPage');
                clonedPaper.style.position = 'fixed';
                clonedPaper.style.left = '0';
                clonedPaper.style.top = '0';
                clonedPaper.style.transform = 'none';
                clonedPaper.style.display = 'block';
            }
        });
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ
        raportPage.style.position = originalPosition;
        raportPage.style.left = originalLeft;
        raportPage.style.top = originalTop;
        raportPage.style.transform = '';
        raportPage.style.zIndex = originalZIndex;
        raportPage.style.display = originalDisplay;
        
        // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ Blob
        const blob = await new Promise(resolve => {
            c.toBlob(resolve, "image/jpeg", 0.95);
        });
        
        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É
        let nameFromText = extractDateTime(text1.value);
        let today = new Date();
        let fileName = nameFromText ? nameFromText + ".jpg"
            : `–†–∞–ø–æ—Ä—Ç_${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}.jpg`;
        
        const file = new File([blob], fileName, {type: "image/jpeg"});
        
        // Web Share API
        if (navigator.share && navigator.canShare && navigator.canShare({files: [file]})) {
            try {
                await navigator.share({
                    files: [file],
                    title: "–†–∞–ø–æ—Ä—Ç"
                });
                loading.style.display = 'none';
                return;
            } catch (e) {
                console.log("Web Share API –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è:", e);
            }
        }
        
        // Fallback –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            loading.style.display = 'none';
        }, 100);
        
        alert(`–†–∞–ø–æ—Ä—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ —è–∫ "${fileName}"`);
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–∞–ø–æ—Ä—Ç—É:', error);
        loading.style.display = 'none';
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —Ä–∞–ø–æ—Ä—Ç—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
}

// –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
function waitForImages() {
    const images = document.querySelectorAll('img');
    const promises = Array.from(images).map(img => {
        if (img.complete && img.naturalWidth !== 0) return Promise.resolve();
        return new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve;
        });
    });
    return Promise.all(promises);
}

// –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
const settingsModal = document.getElementById('settingsModal');
const cmdInput = document.getElementById('cmdInput');
const posInput = document.getElementById('posInput');
const nameInput = document.getElementById('nameInput');

function openSettingsModal() {
    settingsModal.style.display = 'flex';
    cmdInput.value = localStorage.getItem('cmd') || "";
    posInput.value = localStorage.getItem('pos') || "";
    nameInput.value = localStorage.getItem('name') || "";
    setTimeout(() => cmdInput.focus(), 100);
}

function closeSettingsModal() {
    settingsModal.style.display = 'none';
}

function saveSettings() {
    localStorage.setItem('cmd', cmdInput.value);
    localStorage.setItem('pos', posInput.value);
    localStorage.setItem('name', nameInput.value);
    applySettings();
    closeSettingsModal();
}

function applySettings() {
    document.getElementById('cmdBlock').innerText = localStorage.getItem('cmd') || "–ù–∞–ª–∞—à—Ç—É–π —Ä–∞–ø–æ—Ä—Ç";
    document.getElementById('posBlock').innerText = localStorage.getItem('pos') || "–ù–∞–ª–∞—à—Ç—É–π —Ä–∞–ø–æ—Ä—Ç";
    document.getElementById('nameBlock').innerText = localStorage.getItem('name') || "–ù–∞–ª–∞—à—Ç—É–π —Ä–∞–ø–æ—Ä—Ç";
}

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) {
        closeSettingsModal();
    }
});

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫ –ø–æ Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (settingsModal.style.display === 'flex') closeSettingsModal();
    }
});

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
applySettings();

// –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Ç–∞ –ø—ñ–¥–ø–∏—Å—É)
window.addEventListener('load', () => {
    // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å—É
    const savedSignature = localStorage.getItem('signature');
    if (savedSignature) {
        document.getElementById('signImg').src = savedSignature;
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∏–ø—É —Ä–∞–ø–æ—Ä—Ç—É
    changeReportType();
});
</script>

</body>

</html>


