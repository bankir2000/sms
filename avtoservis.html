<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–æ–≤–Ω–∏–π —Å–µ—Ä–≤—ñ—Å–Ω–∏–π —Ç—Ä–µ–∫–µ—Ä (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
  <style>
    :root {
      --bg: #0f172a; --card: #111827; --muted: #94a3b8; --text: #e5e7eb; --accent: #22c55e;
      --warn: #f59e0b; --danger: #ef4444; --blue: #3b82f6; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: linear-gradient(180deg, #0b1024, #0f172a 40%); color: var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans"; }
    .container { max-width: 1100px; margin: 0 auto; padding: 18px; }
    h1 { margin: 10px 0 18px; font-weight: 800; letter-spacing: .3px; }
    h2 { margin: 0 0 12px; font-weight: 700; }
    .sub { color: var(--muted); font-size: .95rem; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 920px) { .grid { grid-template-columns: 1.2fr .8fr; } }
    .card { background: rgba(17,24,39,.8); border: 1px solid rgba(148,163,184,.15); border-radius: 16px; box-shadow: var(--shadow); padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    label { font-size: .85rem; color: var(--muted); }
    input, select, textarea { width: 100%; background: #0b1220; color: var(--text); border: 1px solid rgba(148,163,184,.2);
      padding: 10px 12px; border-radius: 10px; outline: none; transition: border .2s, box-shadow .2s; }
    input:focus, select:focus, textarea:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    button { background: linear-gradient(180deg, #2563eb, #1d4ed8); color: white; border: 0; border-radius: 12px;
      padding: 10px 14px; font-weight: 700; cursor: pointer; transition: transform .05s ease, box-shadow .2s ease; box-shadow: 0 10px 20px rgba(37,99,235,.25); }
    button:hover { box-shadow: 0 12px 26px rgba(37,99,235,.33); }
    button:active { transform: translateY(1px); }
    .btn-ghost { background: transparent; border: 1px solid rgba(148,163,184,.3); color: var(--text); box-shadow: none; }
    .btn-warn { background: linear-gradient(180deg, #f59e0b, #d97706); box-shadow: 0 10px 20px rgba(245,158,11,.25); }
    .btn-danger { background: linear-gradient(180deg, #ef4444, #dc2626); box-shadow: 0 10px 20px rgba(239,68,68,.25); }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .status { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; font-weight: 700; }
    .ok { background: rgba(34,197,94,.12); color: #86efac; border: 1px solid rgba(34,197,94,.35); }
    .warn { background: rgba(245,158,11,.12); color: #fde68a; border: 1px solid rgba(245,158,11,.35); }
    .danger { background: rgba(239,68,68,.12); color: #fecaca; border: 1px solid rgba(239,68,68,.35); }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid rgba(148,163,184,.12); padding: 10px 8px; vertical-align: top; }
    .table th { text-align: left; color: var(--muted); font-weight: 600; font-size: .85rem; }
    .muted { color: var(--muted); font-size: .9rem; }
    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .right { margin-left: auto; }
    .hidden { display: none; }
    .img-thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(148,163,184,.2); cursor: zoom-in; }
    .divider { height: 1px; background: rgba(148,163,184,.12); margin: 10px 0; border-radius: 99px; }
    .footer-note { color: var(--muted); font-size: .8rem; text-align: center; margin: 16px 0; }
    @media print { body { background: white; color: black; } .card { box-shadow: none; border-radius: 0; border: 1px solid #ddd; } .no-print { display: none !important; } .container { max-width: none; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>–ü–æ–≤–Ω–∏–π —Å–µ—Ä–≤—ñ—Å–Ω–∏–π —Ç—Ä–µ–∫–µ—Ä</h1>
    <div class="sub">–û—Ñ–ª–∞–π–Ω-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –æ–±–ª—ñ–∫—É –¢–û: —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏, –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è, —ñ—Å—Ç–æ—Ä—ñ—è, —á–µ–∫–∏ —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç —É PDF. –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ <b>LocalStorage</b> –≤–∞—à–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é.</div>

    <div class="grid">
      <section class="card">
        <h2>–ü—Ä–æ—Ñ—ñ–ª—å –∞–≤—Ç–æ</h2>
        <div class="row">
          <div>
            <label>–ú–∞—Ä–∫–∞ / –º–æ–¥–µ–ª—å</label>
            <input id="v_make" placeholder="Volkswagen T4 2.5 TDI" />
          </div>
          <div>
            <label>VIN (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <input id="v_vin" placeholder="WV1ZZZ..." />
          </div>
        </div>
        <div class="row">
          <div>
            <label>–ü–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ–±—ñ–≥ (–∫–º)</label>
            <input id="v_odometer" type="number" inputmode="numeric" placeholder="–ù–∞–ø—Ä.: 250000" />
          </div>
          <div class="flex" style="align-items:end">
            <button class="right" id="btnSaveVehicle">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
          </div>
        </div>
        <div class="divider"></div>
        <h2>–Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ –¢–û</h2>
        <div class="sub">–ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –ø—ñ–¥ —Å–≤—ñ–π –∞–≤—Ç–æ–º–æ–±—ñ–ª—å. –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Ö—É—î –∑–∞ <u>–ø—Ä–æ–±—ñ–≥–æ–º</u> —Ç–∞ <u>—á–∞—Å–æ–º</u> (—â–æ –Ω–∞—Å—Ç–∞–Ω–µ —Ä–∞–Ω—ñ—à–µ).</div>
        <div id="intervals"></div>
        <div class="flex" style="margin-top:10px">
          <button id="btnResetIntervals" class="btn-ghost">–°–∫–∏–Ω—É—Ç–∏ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö</button>
          <button id="btnSaveIntervals" class="right">–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏</button>
        </div>
      </section>

      <section class="card">
        <h2>–®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ç—É—Å</h2>
        <div class="sub">–ü–æ–∫–∞–∑—É—î, —â–æ –≥–æ—Ä–∏—Ç—å —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ / —Å–∫–æ—Ä–æ.</div>
        <div class="chips" id="quickStatus"></div>
        <div class="divider"></div>
        <div class="flex">
          <button id="btnRecalc">–ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
          <button id="btnExportPDF" class="btn-warn">–ï–∫—Å–ø–æ—Ä—Ç —É PDF</button>
          <button id="btnBackup" class="btn-ghost right">–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è (JSON)</button>
          <input id="backupFile" type="file" accept="application/json" class="hidden" />
          <button id="btnRestore" class="btn-ghost">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>–î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é –¢–û</h2>
      <div class="row-3">
        <div>
          <label>–¢–∏–ø —Ä–æ–±—ñ—Ç</label>
          <select id="svc_type"></select>
        </div>
        <div>
          <label>–î–∞—Ç–∞</label>
          <input id="svc_date" type="date" />
        </div>
        <div>
          <label>–ü—Ä–æ–±—ñ–≥ (–∫–º)</label>
          <input id="svc_mileage" type="number" inputmode="numeric" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>–í–∞—Ä—Ç—ñ—Å—Ç—å (–≥—Ä–Ω)</label>
          <input id="svc_cost" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä.: 2500" />
        </div>
        <div>
          <label>–ú–∞–≥–∞–∑–∏–Ω / –°–¢–û (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
          <input id="svc_vendor" placeholder="–ù–∞–∑–≤–∞ –°–¢–û –∞–±–æ –º–∞–≥–∞–∑–∏–Ω—É" />
        </div>
      </div>
      <div>
        <label>–ù–æ—Ç–∞—Ç–∫–∞</label>
        <textarea id="svc_note" rows="2" placeholder="–ú–∞—Ä–∫–∞ –º–∞—Å–ª–∞, –Ω–æ–º–µ—Ä —Ñ—ñ–ª—å—Ç—Ä–∞, –ø–µ—Ä–µ–ª—ñ–∫ —Ä–æ–±—ñ—Ç..."></textarea>
      </div>
      <div class="row">
        <div>
          <label>–§–æ—Ç–æ —á–µ–∫—É / —Ä–æ–±—ñ—Ç (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
          <input id="svc_receipt" type="file" accept="image/*" />
        </div>
        <div class="flex" style="align-items:end">
          <button id="btnAddSvc">–î–æ–¥–∞—Ç–∏ —É —ñ—Å—Ç–æ—Ä—ñ—é</button>
          <button id="btnClearForm" class="btn-ghost">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="flex">
        <h2 style="margin-right:auto">–Ü—Å—Ç–æ—Ä—ñ—è –¢–û</h2>
        <input id="search" placeholder="–ü–æ—à—É–∫: —Ç–∏–ø, –Ω–æ—Ç–∞—Ç–∫–∞, –°–¢–û..." style="max-width:320px" />
      </div>
      <div class="sub">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —á–µ–∫, —â–æ–± –∑–±—ñ–ª—å—à–∏—Ç–∏. –î–∞–Ω—ñ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª—è—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –∞–±–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ.</div>
      <div class="divider"></div>
      <table class="table" id="historyTable">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢–∏–ø</th>
            <th>–ü—Ä–æ–±—ñ–≥</th>
            <th>–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
            <th>–°–¢–û</th>
            <th>–ù–æ—Ç–∞—Ç–∫–∞</th>
            <th>–ß–µ–∫</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
      <div class="flex" style="margin-top:10px">
        <button id="btnClearHistory" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
        <div class="right muted" id="historyCount"></div>
      </div>
    </section>

    <div class="footer-note">üíæ –£—Å–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó. –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å—É ‚Äî —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å —Ä–µ–∑–µ—Ä–≤–Ω–æ—é –∫–æ–ø—ñ—î—é JSON.</div>
  </div>

<script>
// === –î–∞–Ω—ñ —Ç–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ ===
const LS_KEYS = { vehicle: 'svc_vehicle', intervals: 'svc_intervals', history: 'svc_history' };
const DEFAULT_INTERVALS = [
  { id: 'oil',        name: '–ú–∞—Å–ª–æ –¥–≤–∏–≥—É–Ω–∞',            km: 10000, months: 12 },
  { id: 'oil_filter', name: '–§—ñ–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω–∏–π',          km: 10000, months: 12 },
  { id: 'air_filter', name: '–§—ñ–ª—å—Ç—Ä –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏–π',        km: 20000, months: 24 },
  { id: 'fuel_filter',name: '–§—ñ–ª—å—Ç—Ä –ø–∞–ª–∏–≤–Ω–∏–π (–¥–∏–∑–µ–ª—å)', km: 20000, months: 24 },
  { id: 'cabin_filter',name:'–§—ñ–ª—å—Ç—Ä —Å–∞–ª–æ–Ω—É',            km: 15000, months: 12 },
  { id: 'timing_belt',name: '–†–µ–º—ñ–Ω—å –ì–†–ú',               km: 60000, months: 48 },
  { id: 'brake_fluid',name: '–ì–∞–ª—å–º—ñ–≤–Ω–∞ —Ä—ñ–¥–∏–Ω–∞',         km: 0,     months: 24 },
  { id: 'coolant',    name: '–û—Ö–æ–ª–æ–¥–∂—É—é—á–∞ —Ä—ñ–¥–∏–Ω–∞ (–∞–Ω—Ç–∏—Ñ—Ä–∏–∑)', km: 0, months: 60 },
  { id: 'brake_pads_f',name:'–ì–∞–ª—å–º. –∫–æ–ª–æ–¥–∫–∏ –ø–µ—Ä–µ–¥–Ω—ñ',   km: 30000, months: 0 },
  { id: 'brake_pads_r',name:'–ì–∞–ª—å–º. –∫–æ–ª–æ–¥–∫–∏ –∑–∞–¥–Ω—ñ',     km: 30000, months: 0 },
  { id: 'tires_season',name:'–ó–∞–º—ñ–Ω–∞ —à–∏–Ω (—Å–µ–∑–æ–Ω)',       km: 0,     months: 6 },
];
let lastDoneMap = {};

// === –£—Ç–∏–ª—ñ—Ç–∏ ===
const $ = (id) => document.getElementById(id);
const todayStr = () => new Date().toISOString().slice(0,10);
function parseNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
function monthsBetween(a, b) { const d1 = new Date(a), d2 = new Date(b); return (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth()); }
function formatMoney(n){ if(!n && n!==0) return ''; return new Intl.NumberFormat('uk-UA').format(n) + ' ‚Ç¥'; }
function dlURL(filename, text) { try{ const blob = new Blob([text], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 3000);}catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞.'); } }
function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }
function genId(){ if (window.crypto?.randomUUID) return crypto.randomUUID(); return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

// === –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è / –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ===
function loadVehicle(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.vehicle) || '{}'); }catch{ return {}; } }
function saveVehicle(v){ localStorage.setItem(LS_KEYS.vehicle, JSON.stringify(v)); }
function loadIntervals(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.intervals) || 'null') || DEFAULT_INTERVALS; }catch{ return DEFAULT_INTERVALS; } }
function saveIntervals(list){ localStorage.setItem(LS_KEYS.intervals, JSON.stringify(list)); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.history) || '[]'); }catch{ return []; } }
function saveHistory(list){ localStorage.setItem(LS_KEYS.history, JSON.stringify(list)); }

// === –†–µ–Ω–¥–µ—Ä —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤ ===
function renderIntervals(){ const list = loadIntervals(); const wrap = document.createElement('div'); list.forEach(item=>{ const row = document.createElement('div'); row.className = 'row'; row.style.marginTop = '8px'; row.innerHTML = `
  <div><label>${item.name} ‚Äî —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–±—ñ–≥—É (–∫–º)</label><input data-id="${item.id}" data-key="km" type="number" value="${item.km}" /></div>
  <div><label>${item.name} ‚Äî —ñ–Ω—Ç–µ—Ä–≤–∞–ª —á–∞—Å—É (–º—ñ—Å—è—Ü—ñ–≤)</label><input data-id="${item.id}" data-key="months" type="number" value="${item.months}" /></div>`; wrap.appendChild(row); }); const holder = $('intervals'); if(holder){ holder.innerHTML = ''; holder.appendChild(wrap); } }

// === –û–±–ª—ñ–∫ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ä–æ–±—ñ—Ç –∑ —ñ—Å—Ç–æ—Ä—ñ—ó ===
function rebuildLastDoneMap(){ lastDoneMap = {}; const history = loadHistory(); history.sort((a,b)=> b.date.localeCompare(a.date)); for(const rec of history){ if(!lastDoneMap[rec.type]){ lastDoneMap[rec.type] = { date: rec.date, mileage: rec.mileage }; } } }

// === –°—Ç–∞—Ç—É—Å –µ–ª–µ–º–µ–Ω—Ç—É –∑–∞ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º ===
function calcStatus(item, vehicle){ const last = lastDoneMap[item.id] || { date: vehicle?.startDate || todayStr(), mileage: vehicle?.startMileage || 0 }; const nowDate = todayStr(); const months = item.months>0 ? monthsBetween(last.date || nowDate, nowDate) : 0; const kmPassed = Math.max(0, parseNum(vehicle?.odometer) - parseNum(last.mileage)); const kmLeft = item.km>0 ? Math.max(0, item.km - kmPassed) : Infinity; const monthsLeft = item.months>0 ? Math.max(0, item.months - months) : Infinity; let level = 'ok'; if ((item.km>0 && kmLeft<=0) || (item.months>0 && monthsLeft<=0)) level = 'danger'; else if ((item.km>0 && kmLeft<=1000) || (item.months>0 && monthsLeft<=1)) level = 'warn'; const nextKmAt = (last.mileage || 0) + (item.km||0); return { level, last, nextKmAt, kmLeft, monthsLeft }; }
function levelRank(l){ return l==='danger'?3 : l==='warn'?2 : 1; }
function renderQuickStatus(){ const vehicle = loadVehicle(); const list = loadIntervals(); rebuildLastDoneMap(); const box = $('quickStatus'); if(!box) return; box.innerHTML=''; const cards = list.map(item=>{ const st = calcStatus(item, vehicle); const el = document.createElement('div'); el.className = `status ${st.level}`; const kmTxt = item.km>0 ? (isFinite(st.kmLeft) ? `${st.kmLeft.toFixed(0)} –∫–º` : '‚Äî') : '‚Äî'; const moTxt = item.months>0 ? (isFinite(st.monthsLeft) ? `${st.monthsLeft.toFixed(0)} –º—ñ—Å` : '‚Äî') : '‚Äî'; el.title = `–û—Å—Ç–∞–Ω–Ω—î: ${st.last.date || '‚Äî'}, ${st.last.mileage??'‚Äî'} –∫–º | –ù–∞—Å—Ç—É–ø–Ω–µ: ${item.km? (st.nextKmAt+' –∫–º') : '–∑–∞ —á–∞—Å–æ–º'}.`; el.innerHTML = `${item.name} ¬∑ –∑–∞–ª–∏—à–∏–ª–æ—Å—å: ${kmTxt} / ${moTxt}`; return {level: st.level, el}; }).sort((a,b)=> levelRank(b.level)-levelRank(a.level)); cards.forEach(c=> box.appendChild(c.el)); }

// === –Ü—Å—Ç–æ—Ä—ñ—è —Ä–µ–Ω–¥–µ—Ä ===
function renderHistory(){ const q = ($('search')?.value||'').trim().toLowerCase(); const body = $('historyBody'); if(!body) return; const list = loadHistory(); const intervals = loadIntervals(); const byId = Object.fromEntries(intervals.map(i=>[i.id, i.name])); body.innerHTML=''; list.filter(r=> !q || [r.type, r.note, r.vendor].filter(Boolean).some(v=> String(v).toLowerCase().includes(q))).sort((a,b)=> b.date.localeCompare(a.date) || b.mileage - a.mileage).forEach((r)=>{ const tr = document.createElement('tr'); const img = r.receipt ? (()=>{ const i = document.createElement('img'); i.className='img-thumb'; i.src=r.receipt; i.alt='—á–µ–∫'; i.addEventListener('click', ()=> window.open(r.receipt, '_blank')); return i; })() : null; tr.innerHTML = `
  <td>${r.date}</td>
  <td>${byId[r.type] || r.type}</td>
  <td>${(r.mileage??'').toLocaleString?.('uk-UA') || r.mileage || ''}</td>
  <td>${r.cost? formatMoney(r.cost): '<span class="muted">‚Äî</span>'}</td>
  <td>${r.vendor? r.vendor: '<span class="muted">‚Äî</span>'}</td>
  <td>${r.note? r.note: '<span class="muted">‚Äî</span>'}</td>
  <td class="receipt-cell"></td>
  <td><button class="btn-ghost" data-del="${r.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>`; body.appendChild(tr); if(img) tr.querySelector('.receipt-cell').appendChild(img); tr.querySelector('[data-del]')?.addEventListener('click', ()=> deleteRecord(r.id)); }); const cnt = $('historyCount'); if(cnt) cnt.textContent = `–ó–∞–ø–∏—Å—ñ–≤: ${list.length}`; }
function deleteRecord(id){ if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?')) return; const list = loadHistory().filter(r=> r.id!==id); saveHistory(list); rebuildLastDoneMap(); renderHistory(); renderQuickStatus(); }

// === –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–¥—ñ—ó ===
async function addService(){ const type = $('svc_type')?.value; const date = $('svc_date')?.value || todayStr(); const mileage = parseNum($('svc_mileage')?.value); const cost = parseNum($('svc_cost')?.value); const vendor = $('svc_vendor')?.value.trim(); const note = $('svc_note')?.value.trim(); if (!type) { alert('–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ä–æ–±—ñ—Ç.'); return; } if (mileage < 0) { alert('–ü—Ä–æ–±—ñ–≥ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥‚Äô—î–º–Ω–∏–º.'); return; } if (cost < 0) { alert('–í–∞—Ä—Ç—ñ—Å—Ç—å –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥‚Äô—î–º–Ω–æ—é.'); return; } if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { alert('–î–∞—Ç–∞ –º–∞—î –±—É—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ –†–†–†–†-–ú–ú-–î–î.'); return; }
  let receipt = null; const f = $('svc_receipt')?.files?.[0]; if(f){ if(!f.type.startsWith('image/')){ alert('–ß–µ–∫ –º–∞—î –±—É—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º.'); return; } if(f.size > 3*1024*1024){ if(!confirm('–§–∞–π–ª > 3 –ú–ë. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) return; } try{ receipt = await fileToBase64(f); }catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª —á–µ–∫—É.'); } }
  const rec = { id: genId(), type, date, mileage, cost, vendor, note, receipt, createdAt: new Date().toISOString() };
  const hist = loadHistory(); hist.push(rec); try{ saveHistory(hist);}catch(e){ alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —É LocalStorage.'); return; }
  if(mileage>0){ const v = loadVehicle(); v.odometer = Math.max(parseNum(v.odometer), mileage); try{ saveVehicle(v);}catch(e){} if($('v_odometer')) $('v_odometer').value = v.odometer; }
  ['svc_mileage','svc_cost','svc_vendor','svc_note','svc_receipt'].forEach(id=>{ const el=$(id); if(el) el.value=''; }); if($('svc_date')) $('svc_date').value=todayStr(); rebuildLastDoneMap(); renderHistory(); renderQuickStatus(); alert('‚úÖ –î–æ–¥–∞–Ω–æ —É —ñ—Å—Ç–æ—Ä—ñ—é'); }

// === –ï–∫—Å–ø–æ—Ä—Ç —É PDF ===
function exportPDF(){ try{ const { jsPDF } = window.jspdf || {}; if(!jsPDF) { window.print(); return; } const doc = new jsPDF({ unit: 'pt', format: 'a4' }); const vehicle = loadVehicle(); const title = `–°–µ—Ä–≤—ñ—Å–Ω–∏–π —Ç—Ä–µ–∫–µ—Ä ‚Äî ${vehicle.make || ''}`.trim(); doc.setFontSize(16); doc.text(title, 40, 40); doc.setFontSize(10); doc.text(new Date().toLocaleString('uk-UA'), 40, 58); const intervals = loadIntervals(); rebuildLastDoneMap(); let y=90; doc.setFontSize(12); doc.text('–®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ç—É—Å', 40, y); y+=12; const statuses = intervals.map(i=>({i, st: calcStatus(i, loadVehicle())})).sort((a,b)=> levelRank(b.st.level)-levelRank(a.st.level)); doc.setFontSize(10); statuses.forEach(({i, st})=>{ const kmTxt = i.km>0 && isFinite(st.kmLeft)? `${st.kmLeft.toFixed(0)} –∫–º` : '‚Äî'; const moTxt = i.months>0 && isFinite(st.monthsLeft)? `${st.monthsLeft.toFixed(0)} –º—ñ—Å` : '‚Äî'; const line = `${i.name}: ${st.level.toUpperCase()} ¬∑ –∑–∞–ª–∏—à–∏–ª–æ—Å—å ${kmTxt} / ${moTxt}`; if(y>760){ doc.addPage(); y=40; } doc.text(line, 50, y); y+=14; }); const hist = loadHistory().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,25); y+=10; if(y>760){ doc.addPage(); y=40; } doc.setFontSize(12); doc.text('–Ü—Å—Ç–æ—Ä—ñ—è –¢–û (–æ—Å—Ç–∞–Ω–Ω—ñ –∑–∞–ø–∏—Å–∏)', 40, y); y+=12; doc.setFontSize(9); hist.forEach(r=>{ const intervalsMap = Object.fromEntries(loadIntervals().map(x=>[x.id,x.name])); const line = `${r.date} ¬∑ ${intervalsMap[r.type] || r.type} ¬∑ ${r.mileage?.toLocaleString('uk-UA')} –∫–º ¬∑ ${r.vendor||''} ¬∑ ${r.note||''} ${r.cost? '¬∑ '+formatMoney(r.cost): ''}`; const chunks = splitText(doc, line, 510); chunks.forEach(ch=>{ if(y>780){ doc.addPage(); y=40; } doc.text(ch, 50, y); y+=12; }); y+=2; }); const fname = `service-tracker-${new Date().toISOString().slice(0,10)}.pdf`; doc.save(fname); } catch(e){ console.error(e); window.print(); } }
function splitText(doc, text, maxWidth){ const words = text.split(' '); const lines=[]; let cur=''; words.forEach(w=>{ const t = cur? cur+' '+w : w; if(doc.getTextWidth(t)>maxWidth){ if(cur) lines.push(cur); cur=w; } else cur=t; }); if(cur) lines.push(cur); return lines; }

// === –†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è ===
function backup(){ const data = { vehicle: loadVehicle(), intervals: loadIntervals(), history: loadHistory(), exportedAt: new Date().toISOString(), version: 1 }; dlURL('service-tracker-backup.json', JSON.stringify(data, null, 2)); }
function restore(file){ const reader = new FileReader(); reader.onload = () => { try{ const data = JSON.parse(reader.result); if(typeof data !== 'object' || !data) throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó'); if(data.vehicle && typeof data.vehicle === 'object') saveVehicle(data.vehicle); else if(data.vehicle!==undefined) throw new Error('–ü–æ–ª–µ vehicle –ø–æ—à–∫–æ–¥–∂–µ–Ω–µ'); if(Array.isArray(data.intervals)) saveIntervals(data.intervals); else if(data.intervals!==undefined) throw new Error('–ü–æ–ª–µ intervals –ø–æ—à–∫–æ–¥–∂–µ–Ω–µ'); if(Array.isArray(data.history)) saveHistory(data.history); else if(data.history!==undefined) throw new Error('–ü–æ–ª–µ history –ø–æ—à–∫–æ–¥–∂–µ–Ω–µ'); hydrateUI(); alert('‚úÖ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó'); }catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è: '+ (e?.message||'–Ω–µ–≤—ñ–¥–æ–º–æ')); } }; reader.onerror = ()=> alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó'); reader.readAsText(file); }

// === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è UI ===
function hydrateVehicle(){ const v = loadVehicle(); if($('v_make')) $('v_make').value = v.make||''; if($('v_vin')) $('v_vin').value = v.vin||''; if($('v_odometer')) $('v_odometer').value = v.odometer||''; }
function hydrateTypes(){ const sel = $('svc_type'); if(sel){ sel.innerHTML=''; loadIntervals().forEach(i=>{ const o = document.createElement('option'); o.value=i.id; o.textContent=i.name; sel.appendChild(o); }); } if($('svc_date')) $('svc_date').value = todayStr(); }
function hydrateUI(){ hydrateVehicle(); renderIntervals(); hydrateTypes(); rebuildLastDoneMap(); renderHistory(); renderQuickStatus(); }

function saveVehicleFromUI(){ const existing = loadVehicle(); const newOdo = parseNum($('v_odometer')?.value); const prevOdo = parseNum(existing.odometer); if (newOdo < prevOdo) { if(!confirm(`–ù–æ–≤–∏–π –æ–¥–æ–º–µ—Ç—Ä (${newOdo.toLocaleString('uk-UA')} –∫–º) –º–µ–Ω—à–∏–π –∑–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π (${prevOdo.toLocaleString('uk-UA')} –∫–º). –í—Å–µ –æ–¥–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏?`)) return; } const v = { make: $('v_make')?.value.trim(), vin: $('v_vin')?.value.trim(), odometer: newOdo, startDate: existing.startDate || todayStr(), startMileage: Number.isFinite(existing.startMileage) ? existing.startMileage : newOdo }; try{ saveVehicle(v);}catch(e){ alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –≤ LocalStorage.'); return; } renderQuickStatus(); alert('‚úÖ –ü—Ä–æ—Ñ—ñ–ª—å –∞–≤—Ç–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ'); }
function saveIntervalsFromUI(){ const holder = $('intervals'); if(!holder) return; const inputs = holder.querySelectorAll('input[data-id]'); const map = {}; inputs.forEach(inp=>{ const id = inp.getAttribute('data-id'); const key = inp.getAttribute('data-key'); map[id] = map[id] || { id }; map[id][key] = parseNum(inp.value); }); const current = loadIntervals(); const updated = current.map(it=> ({...it, ...(map[it.id]||{}) })); saveIntervals(updated); hydrateTypes(); renderQuickStatus(); alert('‚úÖ –Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ'); }
function resetIntervals(){ if(!confirm('–°–∫–∏–Ω—É—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö?')) return; saveIntervals(DEFAULT_INTERVALS); renderIntervals(); hydrateTypes(); renderQuickStatus(); }
function clearForm(){ ['svc_mileage','svc_cost','svc_vendor','svc_note','svc_receipt'].forEach(id=>{ const el=$(id); if(el) el.value=''; }); }
function clearHistory(){ if(!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —É—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –¢–û? –¶–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return; saveHistory([]); rebuildLastDoneMap(); renderHistory(); renderQuickStatus(); }

// === —ñ–Ω—ñ—Ç ===
window.addEventListener('DOMContentLoaded', ()=>{
  try{ hydrateUI(); }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.'); }
  $('btnSaveVehicle')?.addEventListener('click', saveVehicleFromUI);
  $('btnSaveIntervals')?.addEventListener('click', saveIntervalsFromUI);
  $('btnResetIntervals')?.addEventListener('click', resetIntervals);
  $('btnRecalc')?.addEventListener('click', ()=>{ rebuildLastDoneMap(); renderQuickStatus(); });
  $('btnExportPDF')?.addEventListener('click', exportPDF);
  $('btnBackup')?.addEventListener('click', backup);
  $('btnRestore')?.addEventListener('click', ()=> $('backupFile')?.click());
  $('backupFile')?.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) restore(f); e.target.value=''; });
  $('btnAddSvc')?.addEventListener('click', addService);
  $('btnClearForm')?.addEventListener('click', clearForm);
  $('btnClearHistory')?.addEventListener('click', clearHistory);
  $('search')?.addEventListener('input', renderHistory);
});
</script>
</body>
</html>

